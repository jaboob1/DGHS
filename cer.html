<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>حاسبة رصيد الإجازة المتقدمة</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            background-color: #f5f5f5;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2c3e50;
        }
        input[type="date"], input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        .date-range {
            display: flex;
            gap: 15px;
        }
        .date-range > div {
            flex: 1;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #2980b9;
        }
        .results {
            margin-top: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 5px;
            display: none;
        }
        .results h2 {
            margin-top: 0;
            color: #2c3e50;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
        }
        .result-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px 0;
        }
        .result-item.total {
            border-top: 1px solid #ddd;
            margin-top: 10px;
            padding-top: 15px;
            font-weight: bold;
            font-size: 18px;
            color: #2c3e50;
        }
        .vacation-list {
            margin-top: 20px;
        }
        .vacation-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background-color: #e8f4fc;
            margin-bottom: 10px;
            border-radius: 5px;
        }
        .remove-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            width: auto;
        }
        .remove-btn:hover {
            background-color: #c0392b;
        }
        .error {
            color: #e74c3c;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }
        .official-holidays {
            margin-top: 20px;
            padding: 15px;
            background-color: #f0f7ff;
            border-radius: 5px;
            border: 1px solid #d1e7ff;
        }
        .holiday-item {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: flex-end;
        }
        .holiday-item > div {
            flex: 1;
        }
        .section-title {
            color: #2c3e50;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
            margin-top: 30px;
            margin-bottom: 15px;
        }
        .add-holiday-btn {
            background-color: #2ecc71;
            margin-top: 10px;
        }
        .add-holiday-btn:hover {
            background-color: #27ae60;
        }
        .holiday-list {
            margin-top: 20px;
        }
        .holiday-list-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background-color: #e8f6ef;
            margin-bottom: 10px;
            border-radius: 5px;
        }
        .calculation-details {
            margin-top: 20px;
            padding: 15px;
            background-color: #fff9e6;
            border-radius: 5px;
            border: 1px solid #ffeaa7;
        }
        .month-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px dashed #ddd;
        }
        .month-item:last-child {
            border-bottom: none;
        }
        .compensation-info {
            margin-top: 15px;
            padding: 10px;
            background-color: #e8f6ef;
            border-radius: 5px;
            font-size: 14px;
        }
        .compensation-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        .exceeded-days {
            margin-top: 20px;
            padding: 15px;
            background-color: #ffebee;
            border-radius: 5px;
            border: 1px solid #ffcdd2;
        }
        .exceeded-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background-color: #ffcdd2;
            margin-bottom: 10px;
            border-radius: 5px;
        }
        .warning {
            color: #c62828;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>حاسبة رصيد إجازة الموظف المتقدمة</h1>
        
        <div class="form-group">
            <label for="hiringDate">تاريخ التعيين:</label>
            <input type="date" id="hiringDate">
        </div>
        
        <h3 class="section-title">الإجازات العادية</h3>
        <div class="form-group">
            <label>فترة الإجازة:</label>
            <div class="date-range">
                <div>
                    <label for="vacationStart">من:</label>
                    <input type="date" id="vacationStart">
                </div>
                <div>
                    <label for="vacationEnd">إلى:</label>
                    <input type="date" id="vacationEnd">
                </div>
            </div>
            <div id="dateError" class="error">يجب أن يكون تاريخ البداية قبل تاريخ النهاية</div>
        </div>
        
        <button id="addVacationBtn" style="background-color: #2ecc71;">إضافة إجازة عادية</button>
        
        <h3 class="section-title">الإجازات الرسمية</h3>
        <div class="official-holidays">
            <div class="holiday-item">
                <div>
                    <label for="holidayName">اسم الإجازة الرسمية:</label>
                    <input type="text" id="holidayName" placeholder="مثال: عيد الفطر">
                </div>
                <div>
                    <label for="holidayStart">من:</label>
                    <input type="date" id="holidayStart">
                </div>
                <div>
                    <label for="holidayEnd">إلى:</label>
                    <input type="date" id="holidayEnd">
                </div>
            </div>
            <button id="addHolidayBtn" class="add-holiday-btn">إضافة إجازة رسمية</button>
        </div>
        
        <button id="calculateBtn">حساب الرصيد الكلي</button>
        
        <div class="results" id="results">
            <h2>نتائج الحساب</h2>
            <div class="result-item">
                <span>تاريخ التعيين:</span>
                <span id="hiringDateResult"></span>
            </div>
            <div class="result-item">
                <span>عدد أشهر العمل:</span>
                <span id="monthsWorked"></span>
            </div>
            <div class="result-item">
                <span>عدد أيام العمل:</span>
                <span id="daysWorked"></span>
            </div>
            <div class="result-item">
                <span>رصيد الإجازة المستحق:</span>
                <span id="vacationBalance"></span>
            </div>
            <div class="result-item">
                <span>الإجازات الرسمية المضافة:</span>
                <span id="officialHolidaysTotal"></span>
            </div>
            
            <div class="calculation-details" id="calculationDetails">
                <h3>تفاصيل حساب الاستحقاق الشهري</h3>
                <!-- سيتم إضافة تفاصيل الحساب الشهري هنا -->
            </div>
            
            <div class="compensation-info" id="compensationInfo">
                <h4>تعويض الإجازات الرسمية المتقاطعة مع الإجازات العادية</h4>
                <!-- سيتم إضافة تفاصيل التعويض هنا -->
            </div>
            
            <div class="vacation-list" id="vacationList">
                <h3>الإجازات العادية المضافة</h3>
                <!-- سيتم إضافة فترات الإجازة العادية هنا -->
            </div>
            
            <div class="holiday-list" id="holidayList">
                <h3>الإجازات الرسمية المضافة</h3>
                <!-- سيتم إضافة فترات الإجازة الرسمية هنا -->
            </div>
            
            <div class="exceeded-days" id="exceededDays">
                <h3 class="warning">الأيام الزائدة عن الرصيد (خصم من الراتب)</h3>
                <!-- سيتم إضافة الأيام الزائدة هنا -->
            </div>
            
            <div class="result-item total">
                <span>الرصيد المتبقي:</span>
                <span id="remainingBalance"></span>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const hiringDateInput = document.getElementById('hiringDate');
            const vacationStartInput = document.getElementById('vacationStart');
            const vacationEndInput = document.getElementById('vacationEnd');
            const holidayNameInput = document.getElementById('holidayName');
            const holidayStartInput = document.getElementById('holidayStart');
            const holidayEndInput = document.getElementById('holidayEnd');
            const calculateBtn = document.getElementById('calculateBtn');
            const addVacationBtn = document.getElementById('addVacationBtn');
            const addHolidayBtn = document.getElementById('addHolidayBtn');
            const resultsDiv = document.getElementById('results');
            const dateError = document.getElementById('dateError');
            const calculationDetails = document.getElementById('calculationDetails');
            const compensationInfo = document.getElementById('compensationInfo');
            const exceededDaysDiv = document.getElementById('exceededDays');
            
            let vacations = [];
            let officialHolidays = [];
            
            // تعيين التواريخ الافتراضية
            const today = new Date();
            hiringDateInput.valueAsDate = new Date(today.getFullYear() - 1, today.getMonth(), today.getDate());
            vacationStartInput.valueAsDate = new Date();
            vacationEndInput.valueAsDate = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000); // بعد أسبوع
            
            // تعيين تاريخ الإجازة الرسمية الافتراضي
            holidayStartInput.valueAsDate = new Date();
            holidayEndInput.valueAsDate = new Date(today.getTime() + 3 * 24 * 60 * 60 * 1000); // 3 أيام
            
            calculateBtn.addEventListener('click', calculateVacationBalance);
            addVacationBtn.addEventListener('click', addVacation);
            addHolidayBtn.addEventListener('click', addOfficialHoliday);
            
            // دالة للحصول على عدد أيام الشهر
            function getDaysInMonth(year, month) {
                return new Date(year, month + 1, 0).getDate();
            }
            
            // دالة لتنسيق التاريخ
            function formatDate(date) {
                return date.toLocaleDateString('ar-EG');
            }
            
            // دالة لتنسيق اسم الشهر
            function getMonthName(monthIndex) {
                const months = [
                    "يناير", "فبراير", "مارس", "أبريل", "مايو", "يونيو",
                    "يوليو", "أغسطس", "سبتمبر", "أكتوبر", "نوفمبر", "ديسمبر"
                ];
                return months[monthIndex];
            }
            
            // دالة للتحقق من التقاطع بين فترتين
            function dateRangesOverlap(start1, end1, start2, end2) {
                return start1 <= end2 && end1 >= start2;
            }
            
            // دالة لحساب عدد أيام التقاطع بين فترتين
            function calculateOverlapDays(start1, end1, start2, end2) {
                if (!dateRangesOverlap(start1, end1, start2, end2)) {
                    return 0;
                }
                
                const overlapStart = new Date(Math.max(start1.getTime(), start2.getTime()));
                const overlapEnd = new Date(Math.min(end1.getTime(), end2.getTime()));
                
                const timeDiff = overlapEnd.getTime() - overlapStart.getTime();
                return Math.ceil(timeDiff / (1000 * 3600 * 24)) + 1; // +1 لتضمين اليوم الأول
            }
            
            function calculateVacationBalance() {
                const hiringDate = new Date(hiringDateInput.value);
                const today = new Date();
                
                if (!hiringDateInput.value) {
                    alert('يرجى إدخال تاريخ التعيين');
                    return;
                }
                
                if (hiringDate > today) {
                    alert('تاريخ التعيين لا يمكن أن يكون في المستقبل');
                    return;
                }
                
                // حساب عدد أشهر العمل
                let monthsWorked = (today.getFullYear() - hiringDate.getFullYear()) * 12;
                monthsWorked -= hiringDate.getMonth();
                monthsWorked += today.getMonth();
                
                // إذا كان يوم الشهر الحالي أقل من يوم التعيين، نخصم شهر
                if (today.getDate() < hiringDate.getDate()) {
                    monthsWorked--;
                }
                
                // حساب عدد أيام العمل
                const timeDiff = today.getTime() - hiringDate.getTime();
                const daysWorked = Math.ceil(timeDiff / (1000 * 3600 * 24));
                
                // حساب رصيد الإجازة بناءً على الاستحقاق اليومي الدقيق لكل شهر
                let totalVacationBalance = 0;
                let currentDate = new Date(hiringDate);
                let calculationDetailsHTML = '<h3>تفاصيل حساب الاستحقاق الشهري</h3>';
                
                // إضافة تفاصيل الحساب لكل شهر
                while (currentDate <= today) {
                    const year = currentDate.getFullYear();
                    const month = currentDate.getMonth();
                    const daysInMonth = getDaysInMonth(year, month);
                    
                    // حساب عدد أيام العمل في هذا الشهر
                    let daysWorkedInMonth;
                    
                    if (currentDate.getFullYear() === hiringDate.getFullYear() && 
                        currentDate.getMonth() === hiringDate.getMonth()) {
                        // الشهر الأول (من تاريخ التعيين إلى نهاية الشهر)
                        daysWorkedInMonth = daysInMonth - currentDate.getDate() + 1;
                    } else if (currentDate.getFullYear() === today.getFullYear() && 
                              currentDate.getMonth() === today.getMonth()) {
                        // الشهر الحالي (من بداية الشهر إلى تاريخ اليوم)
                        daysWorkedInMonth = today.getDate();
                    } else {
                        // شهر كامل
                        daysWorkedInMonth = daysInMonth;
                    }
                    
                    // حساب الاستحقاق لهذا الشهر (4 أيام مقسمة على أيام الشهر)
                    const monthlyRate = 4 / daysInMonth;
                    const monthVacation = daysWorkedInMonth * monthlyRate;
                    totalVacationBalance += monthVacation;
                    
                    // إضافة تفاصيل الشهر للعرض
                    calculationDetailsHTML += `
                        <div class="month-item">
                            <span>${getMonthName(month)} ${year}</span>
                            <span>${daysWorkedInMonth} يوم عمل × (${(monthlyRate).toFixed(4)} يوم/يوم) = ${monthVacation.toFixed(2)} يوم</span>
                        </div>
                    `;
                    
                    // الانتقال إلى الشهر التالي
                    currentDate.setMonth(currentDate.getMonth() + 1);
                    currentDate.setDate(1);
                }
                
                // تحديث تفاصيل الحساب
                calculationDetails.innerHTML = calculationDetailsHTML;
                
                // حساب إجمالي أيام الإجازة العادية المأخوذة
                let totalVacationDays = 0;
                let compensationDetailsHTML = '<h4>تعويض الإجازات الرسمية المتقاطعة مع الإجازات العادية</h4>';
                let totalCompensationDays = 0;
                
                // حساب الإجازات العادية مع استبعاد الأيام التي تتقاطع مع الإجازات الرسمية
                vacations.forEach((vacation, index) => {
                    let vacationDays = vacation.days;
                    
                    // التحقق من التقاطع مع الإجازات الرسمية
                    officialHolidays.forEach(holiday => {
                        const overlapDays = calculateOverlapDays(
                            vacation.start, vacation.end, 
                            holiday.start, holiday.end
                        );
                        
                        if (overlapDays > 0) {
                            vacationDays -= overlapDays;
                            totalCompensationDays += overlapDays;
                            
                            compensationDetailsHTML += `
                                <div class="compensation-item">
                                    <span>${holiday.name} (${formatDate(holiday.start)} - ${formatDate(holiday.end)})</span>
                                    <span>+${overlapDays} يوم تعويض</span>
                                </div>
                            `;
                        }
                    });
                    
                    totalVacationDays += vacationDays;
                });
                
                if (totalCompensationDays === 0) {
                    compensationDetailsHTML += '<p>لا توجد إجازات رسمية متقاطعة مع إجازات عادية</p>';
                }
                
                compensationInfo.innerHTML = compensationDetailsHTML;
                
                // حساب إجمالي أيام الإجازات الرسمية المضافة
                const totalHolidayDays = officialHolidays.reduce((total, holiday) => {
                    return total + holiday.days;
                }, 0);
                
                // حساب الرصيد المتبقي (يشمل الإجازات الرسمية والتعويض عن الأيام المتقاطعة)
                const remainingBalance = (totalVacationBalance + totalHolidayDays + totalCompensationDays) - totalVacationDays;
                
                // حساب الأيام الزائدة عن الرصيد (التي سيتم خصمها من الراتب)
                let exceededDaysHTML = '<h3 class="warning">الأيام الزائدة عن الرصيد (خصم من الراتب)</h3>';
                let totalExceededDays = 0;
                
                if (remainingBalance < 0) {
                    totalExceededDays = Math.abs(remainingBalance);
                    exceededDaysHTML += `
                        <div class="exceeded-item">
                            <div>
                                <span>إجمالي الأيام الزائدة:</span>
                            </div>
                            <div>
                                <span class="warning">${totalExceededDays} يوم</span>
                            </div>
                        </div>
                        <p class="warning">سيتم خصم ${totalExceededDays} يوم من الراتب لعدم توفر رصيد إجازة كافي</p>
                    `;
                    
                    // حساب الأيام الزائدة لكل إجازة
                    let tempBalance = totalVacationBalance + totalHolidayDays + totalCompensationDays;
                    
                    vacations.forEach((vacation, index) => {
                        let vacationDays = vacation.days;
                        
                        // استبعاد الأيام المتقاطعة مع الإجازات الرسمية
                        officialHolidays.forEach(holiday => {
                            const overlapDays = calculateOverlapDays(
                                vacation.start, vacation.end, 
                                holiday.start, holiday.end
                            );
                            
                            if (overlapDays > 0) {
                                vacationDays -= overlapDays;
                            }
                        });
                        
                        if (tempBalance >= vacationDays) {
                            // لا توجد أيام زائدة في هذه الإجازة
                            tempBalance -= vacationDays;
                        } else {
                            // هناك أيام زائدة في هذه الإجازة
                            const exceededInThisVacation = vacationDays - tempBalance;
                            totalExceededDays += exceededInThisVacation;
                            
                            exceededDaysHTML += `
                                <div class="exceeded-item">
                                    <div>
                                        <span>${formatDate(vacation.start)} - ${formatDate(vacation.end)}</span>
                                    </div>
                                    <div>
                                        <span class="warning">${exceededInThisVacation} يوم</span>
                                    </div>
                                </div>
                            `;
                            
                            tempBalance = 0;
                        }
                    });
                } else {
                    exceededDaysHTML += '<p>لا توجد أيام زائدة عن الرصيد</p>';
                }
                
                exceededDaysDiv.innerHTML = exceededDaysHTML;
                
                // عرض النتائج
                document.getElementById('hiringDateResult').textContent = formatDate(hiringDate);
                document.getElementById('monthsWorked').textContent = monthsWorked;
                document.getElementById('daysWorked').textContent = daysWorked;
                document.getElementById('vacationBalance').textContent = totalVacationBalance.toFixed(2) + ' يوم';
                document.getElementById('officialHolidaysTotal').textContent = totalHolidayDays + ' يوم';
                document.getElementById('remainingBalance').textContent = Math.max(remainingBalance, 0).toFixed(2) + ' يوم';
                
                // تحديث قائمة الإجازات
                updateVacationList();
                updateHolidayList();
                
                // إظهار النتائج
                resultsDiv.style.display = 'block';
            }
            
            function addVacation() {
                const startDate = new Date(vacationStartInput.value);
                const endDate = new Date(vacationEndInput.value);
                
                if (!vacationStartInput.value || !vacationEndInput.value) {
                    alert('يرجى إدخال تاريخي بداية ونهاية الإجازة');
                    return;
                }
                
                if (startDate > endDate) {
                    dateError.style.display = 'block';
                    return;
                } else {
                    dateError.style.display = 'none';
                }
                
                // حساب عدد أيام الإجازة
                const timeDiff = endDate.getTime() - startDate.getTime();
                const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24)) + 1; // +1 لتضمين اليوم الأول
                
                // إضافة الإجازة إلى القائمة
                vacations.push({
                    start: startDate,
                    end: endDate,
                    days: daysDiff
                });
                
                // إعادة حساب الرصيد
                calculateVacationBalance();
                
                // مسح حقول الإدخال
                vacationStartInput.value = '';
                vacationEndInput.value = '';
            }
            
            function addOfficialHoliday() {
                const name = holidayNameInput.value;
                const startDate = new Date(holidayStartInput.value);
                const endDate = new Date(holidayEndInput.value);
                
                if (!name || !holidayStartInput.value || !holidayEndInput.value) {
                    alert('يرجى إدخال جميع بيانات الإجازة الرسمية');
                    return;
                }
                
                if (startDate > endDate) {
                    alert('يجب أن يكون تاريخ البداية قبل تاريخ النهاية');
                    return;
                }
                
                // حساب عدد أيام الإجازة الرسمية
                const timeDiff = endDate.getTime() - startDate.getTime();
                const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24)) + 1; // +1 لتضمين اليوم الأول
                
                // إضافة الإجازة الرسمية إلى القائمة
                officialHolidays.push({
                    name: name,
                    start: startDate,
                    end: endDate,
                    days: daysDiff
                });
                
                // إعادة حساب الرصيد
                calculateVacationBalance();
                
                // مسح حقول الإدخال
                holidayNameInput.value = '';
                holidayStartInput.value = '';
                holidayEndInput.value = '';
            }
            
            function removeVacation(index) {
                vacations.splice(index, 1);
                calculateVacationBalance();
            }
            
            function removeHoliday(index) {
                officialHolidays.splice(index, 1);
                calculateVacationBalance();
            }
            
            function updateVacationList() {
                const vacationList = document.getElementById('vacationList');
                vacationList.innerHTML = '<h3>الإجازات العادية المضافة</h3>';
                
                if (vacations.length === 0) {
                    vacationList.innerHTML += '<p>لا توجد إجازات عادية مضافة</p>';
                    return;
                }
                
                vacations.forEach((vacation, index) => {
                    const vacationItem = document.createElement('div');
                    vacationItem.className = 'vacation-item';
                    
                    // حساب الأيام الفعلية المخصومة بعد استبعاد الأيام المتقاطعة مع الإجازات الرسمية
                    let actualDays = vacation.days;
                    officialHolidays.forEach(holiday => {
                        const overlapDays = calculateOverlapDays(
                            vacation.start, vacation.end, 
                            holiday.start, holiday.end
                        );
                        if (overlapDays > 0) {
                            actualDays -= overlapDays;
                        }
                    });
                    
                    vacationItem.innerHTML = `
                        <div>
                            <span>${formatDate(vacation.start)} - ${formatDate(vacation.end)}</span>
                            <br>
                            <small>${actualDays} يوم فعلي (${vacation.days} يوم - ${vacation.days - actualDays} يوم إجازة رسمية)</small>
                        </div>
                        <div>
                            <span>${vacation.days} يوم</span>
                            <button class="remove-btn" onclick="removeVacation(${index})">حذف</button>
                        </div>
                    `;
                    vacationList.appendChild(vacationItem);
                });
            }
            
            function updateHolidayList() {
                const holidayList = document.getElementById('holidayList');
                holidayList.innerHTML = '<h3>الإجازات الرسمية المضافة</h3>';
                
                if (officialHolidays.length === 0) {
                    holidayList.innerHTML += '<p>لا توجد إجازات رسمية مضافة</p>';
                    return;
                }
                
                officialHolidays.forEach((holiday, index) => {
                    const holidayItem = document.createElement('div');
                    holidayItem.className = 'holiday-list-item';
                    holidayItem.innerHTML = `
                        <div>
                            <span>${holiday.name}: ${formatDate(holiday.start)} - ${formatDate(holiday.end)}</span>
                        </div>
                        <div>
                            <span>${holiday.days} يوم</span>
                            <button class="remove-btn" onclick="removeHoliday(${index})">حذف</button>
                        </div>
                    `;
                    holidayList.appendChild(holidayItem);
                });
            }
            
            // جعل الدوال متاحة بشكل عام
            window.removeVacation = removeVacation;
            window.removeHoliday = removeHoliday;
            
            // حساب الرصيد عند تحميل الصفحة
            calculateVacationBalance();
        });
    </script>
</body>
</html>